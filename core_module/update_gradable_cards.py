import os
import sys

from web.backend.containers import AppContainer
from web.backend.db.dao.candidates_dao import CandidatesDAO
from web.backend.db.dao.psa_dao import PsaDAO
from web.backend.db.dao.sales_dao import SalesDAO
from web.backend.db.dao.sales_volume_refresh_log_dao import SalesVolumeRefreshLogDAO
from web.backend.db.dao.set_dao import SetDAO
from web.backend.db.util.cache_to_db_migation import populate_card_analytics_from_db, \
    populate_grading_financials_from_db

# This adds the project root to the Python path.
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.insert(0, project_root)
from core_module.card_data_utils.find_stale_cache_files import find_stale_cache_files
from core_module.card_data_utils.get_target_sets import get_target_set_ids
from core_module.service.domain import get_volume_of_transactions, get_card_prices, get_card_id_psa_pop, get_set_list

list_of_card_ids_no_pop = [17, 19, 20, 21, 63, 66, 69, 73, 74, 77, 79, 83, 88, 90, 92, 95, 96, 103, 119, 120, 146, 211, 325, 334, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 387, 388, 389, 391, 392, 393, 395, 396, 397, 398, 399, 402, 404, 406, 408, 409, 411, 412, 415, 417, 418, 421, 424, 425, 429, 434, 438, 442, 443, 445, 451, 534, 535, 536, 537, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 549, 550, 551, 552, 556, 565, 566, 569, 575, 578, 579, 581, 585, 588, 589, 604, 605, 606, 607, 608, 609, 610, 611, 612, 613, 614, 615, 616, 617, 618, 620, 621, 622, 623, 624, 625, 627, 629, 630, 631, 636, 637, 643, 644, 646, 656, 671, 672, 673, 674, 675, 676, 677, 678, 679, 680, 681, 682, 687, 688, 704, 744, 745, 746, 747, 748, 749, 752, 754, 757, 758, 771, 772, 773, 774, 775, 776, 777, 778, 779, 781, 784, 795, 799, 801, 823, 824, 825, 826, 827, 828, 830, 831, 835, 837, 838, 839, 841, 845, 847, 866, 867, 868, 869, 871, 872, 873, 874, 875, 876, 877, 878, 879, 880, 883, 884, 893, 915, 916, 917, 918, 947, 948, 949, 950, 951, 952, 953, 954, 958, 959, 966, 967, 971, 973, 974, 977, 978, 984, 985, 993, 1010, 1019, 1025, 1026, 1028, 1032, 1033, 1034, 1049, 1070, 1071, 1072, 1078, 1079, 1081, 1086, 1097, 1109, 1110, 1116, 1122, 1198, 1320, 1321, 1322, 1323, 1324, 1325, 1326, 1327, 1329, 1330, 1331, 1332, 1333, 1334, 1340, 1342, 1343, 1348, 1350, 1352, 1354, 1355, 1358, 1360, 1362, 1364, 1394, 1395, 1396, 1397, 1398, 1399, 1400, 1401, 1402, 1403, 1404, 1407, 1408, 1409, 1411, 1415, 1416, 1426, 1429, 1431, 1434, 1436, 1439, 1440, 1442, 1449, 3093, 3094, 3097, 3099, 3106, 3107, 3109, 3115, 3118, 3124, 3129, 3131, 3132, 3134, 3136, 3137, 3138, 3139, 3140, 3142, 3143, 3145, 3146, 3147, 3148, 3151, 3153, 3158, 3159, 3162, 3163, 3167, 3168, 3170, 3171, 3172, 3175, 3178, 3179, 3181, 3182, 3185, 3186, 3187, 3188, 3193, 3195, 3197, 3198, 3199, 3200, 3209, 3211, 3213, 3215, 3229, 3232, 3238, 3251, 3257, 3258, 3262, 3265, 3289, 3305, 3306, 3333, 3335, 3336, 3337, 3338, 3343, 3344, 3425, 3786, 3787, 3788, 3789, 3791, 3792, 3793, 3794, 3796, 3797, 3798, 3809, 3810, 3811, 3812, 3813, 3814, 3815, 3816, 3819, 3820, 3821, 3823, 3824, 3826, 3840, 3841, 3842, 3844, 3845, 3846, 3847, 3851, 3859, 3862, 3863, 3864, 3865, 3866, 3867, 3868, 3869, 3871, 3872, 3874, 3875, 3876, 3882, 3885, 3891, 3892, 3893, 3894, 3895, 3896, 3897, 3898, 3899, 3900, 3901, 3905, 3906, 3907, 3908, 3914, 3924, 3925, 3926, 3927, 3929, 3930, 3931, 3932, 3933, 3934, 3936, 3937, 3938, 3939, 3941, 3942, 3943, 3944, 3946, 3952, 3955, 3956, 3957, 3958, 3960, 3964, 3965, 3966, 3968, 3969, 3970, 3971, 3973, 3975, 3981, 3986, 3987, 3989, 3990, 3992, 3993, 3994, 3998, 3999, 4000, 4001, 4002, 4003, 4005, 4007, 4008, 4017, 4019, 4027, 4028, 4029, 4030, 4031, 4032, 4034, 4036, 4039, 4040, 4055, 4056, 4057, 4058, 4059, 4061, 4063, 4064, 4081, 4082, 4084, 4085, 4086, 4087, 4088, 4089, 4090, 4091, 4093, 4094, 4099, 4104, 4106, 4128, 4129, 4130, 4131, 4132, 4133, 4134, 4136, 4137, 4138, 4139, 4140, 4144, 4148, 4150, 4155, 4157, 4161, 4168, 4169, 4170, 4171, 4172, 4173, 4174, 4176, 4177, 4178, 4183, 4186, 4189, 4191, 4197, 4199, 4200, 4201, 4202, 4204, 4206, 4207, 4208, 4209, 4211, 4214, 4215, 4219, 4220, 4223, 4225, 4230, 4232, 4234, 4237, 8198, 8206, 8211, 8215, 8219, 8220, 8222, 8223, 8224, 8225, 8227, 8236, 8240, 8243, 8245, 8246, 8248, 8249, 8288, 8320, 8333, 8341, 8360, 8369, 8383, 8387, 8393, 8395, 8406, 8417, 8424, 9207, 9551, 9552, 9567, 9801, 9854, 9894, 9896, 9981, 10026, 10058, 10074, 10109, 10124, 10167, 10261, 10322, 10341, 10445, 10630, 10637, 10708, 10839, 10875, 10925, 10941, 11090, 11100, 11271, 11299, 11314, 11412, 11414, 11425, 11431, 11445, 11462, 11490, 11499, 11570, 11586, 11602, 11605, 11702, 11754, 11892, 12066, 12155, 12328, 12496, 12522, 12561, 12935, 12956, 13058, 13447, 13463, 13465, 13466, 13478, 13487, 13515, 13527, 13530, 13539, 13560, 13562, 13565, 13578, 13586, 13818, 13905, 13948, 14064, 14547, 14717, 14799, 14813, 14826, 14866, 14873, 14874, 14891, 14893, 14895, 14926, 14934, 14957, 14960, 14962, 14967, 14979, 15013, 15017, 15045, 15053, 15090, 15133, 15137, 15153, 15160, 15246, 15253, 15281, 15350, 15369, 15386, 15426, 15465, 15470, 15495, 15536, 15552, 15563, 15579, 15593, 15613, 15675, 15683, 15707, 15743, 15762, 15787, 15818, 15871, 15910, 15933, 15949, 15962, 16043, 16061, 16107, 16123, 16204, 16215, 16216, 16272, 16308, 16396, 16442, 16488, 16528, 16672, 16761, 16767, 16820, 16827, 16842, 16844, 16846, 16878, 16941, 16944, 16958, 16962, 16968, 16976, 16989, 17001, 17042, 17056, 17057, 17063, 17069, 17094, 17118, 17172, 17188, 17228, 17245, 17307, 22603, 22605, 22606, 22608, 22609, 22611, 22623, 22625, 22635, 22636, 22638, 22641, 22644, 22647, 27782, 27783, 27784, 27785, 27786, 27787, 27788, 27789, 27790, 27792, 27794, 27797, 27803, 27816, 27817, 27818, 27819, 27821, 27828, 27830, 27833, 27835, 27836, 27852, 27865, 27866, 27943, 27944, 27945, 27946, 27948, 27963, 27964, 27969, 28040, 28050, 28092, 40065, 40067, 40069, 40071, 40072, 40079, 40090, 40091, 40092, 40096, 40097, 40099, 40101, 40105, 40108, 40112, 40114, 40115, 40176, 40177, 40178, 40180, 40182, 40183, 40200, 40202, 40203, 40204, 40207, 40214, 40219, 40220, 40221, 40222, 40223, 40225, 40226, 40227, 40228, 40229, 40231, 40234, 40235, 40236, 40239, 40240, 40241, 40248, 40250, 40256, 40259, 40260, 40263, 40264, 40266, 40269, 40274, 40277, 40279, 40280, 40282, 40283, 40287, 40294, 40295, 40298, 40301, 40308, 40309, 40310, 40313, 40314, 40315, 40318, 40333, 40334, 40339, 40340, 40341, 40343, 40348, 40353, 40354, 40360, 40367, 40370, 40371, 40373, 40374, 40376, 40378, 40380, 40385, 40386, 40391, 40392, 40394, 40395, 40399, 40400, 40401, 40405, 40406, 40414, 40420, 40429, 40437, 40439, 40440, 40446, 40447, 40450, 40456, 40459, 40460, 40464, 40465, 40468, 40469, 40476, 40483, 41127, 41137, 41195, 41237, 41324, 41326, 41327, 41333, 41334, 41335, 41340, 41342, 41348, 41349, 41350, 41550, 42028, 42038, 42050, 42089, 42156, 42198, 42201, 42221, 42224, 42231, 42243, 42256, 42563, 42846, 42914, 42926, 42927, 43194, 43340, 43350, 43861, 43948, 43951, 44144, 44149, 44152, 44153, 44163, 44168, 44170, 44280, 44293, 57255, 57256, 57257, 57452, 57561, 57562, 57630, 57668, 58111, 58147, 58157, 58163, 58164, 58168, 58170, 58173, 58176, 58186, 58187, 58191, 58192, 58199, 58204, 58206, 58207, 59013, 59031, 59042, 59059, 59092, 59095, 59133, 59161, 59162, 59164, 59176, 59192, 59193, 59210, 59212, 59243, 59265, 59501, 59504, 59531, 59608, 59661, 59949, 59962, 59986, 59997, 60000, 60008, 60062, 60120, 60125, 60151, 60153, 60157, 60164, 60183, 60195, 60200, 60218, 60436, 60442, 60446, 61458, 61504, 61508, 61552, 61563, 61597, 61622, 62700, 62726, 62728, 62734, 62738, 62741, 62747, 62752, 62754, 62756, 62757, 62759, 62761, 62765, 62767, 62769, 62848, 62849, 62850, 62878, 62907, 62909, 62940, 62948, 62949, 62952, 62956, 62962, 62998, 63017, 63027, 63034, 63037, 63041, 63332, 63333, 63385, 63437, 63749, 63761, 63774, 63797, 63875, 64965, 65047, 65057, 65068, 65109, 65135, 65138, 65145, 65153, 65171, 65231, 66230, 66361, 66432, 66446, 66462, 66463, 66464, 67094, 67186, 67361, 67495, 67498, 67525, 67528, 67535, 67543, 67717, 67727, 67739, 67755, 67766, 67767, 67768, 67770, 67773, 68028, 68203, 68204, 68205, 68231, 68234, 68237, 68458, 68459, 68485, 68491, 68998, 69010, 69026, 69118, 69128, 69402, 69407, 69429, 71285, 71334, 71565, 71599, 71600, 71601, 71602, 71608, 71609, 72744, 72870, 72907, 72910, 72911, 72982, 73007, 73023, 73104, 73106, 73107, 73109, 73110, 73111, 73113, 73114, 73115, 73116, 73117, 73121, 73122, 73124, 73125, 73126, 73127, 73128, 73129, 73132, 73133, 73139, 73554, 73566, 73589, 73590, 73596, 73602, 73620, 73665, 74008, 74035, 74240, 74558, 74972, 74975, 74997, 75069, 75070, 75071, 75072, 75341, 75342, 75347, 75363, 75364, 75365, 75366, 75367, 75472, 76281, 76496, 76640, 76642, 76661, 76687, 76775, 76781, 76782, 76783, 76784, 76785, 76788, 76790, 76794, 76796, 76803, 76804, 76812, 76820, 76821, 76822, 76823, 76824, 76825, 76827, 76828, 76829, 76831, 76834, 77155, 77202, 77206, 77349, 79841, 79985, 79993]
list_of_volume_data_cards = [1116, 1122, 1198, 3336, 3425, 8126, 8142, 8211, 8224, 8225, 8248, 22609, 22617, 22623, 22624, 22625, 22631, 22635, 22636, 22638, 22641, 22644, 22647, 27944, 27945, 27948, 27959, 27963, 27969, 28050, 28051, 28092, 41127, 41327, 41333, 41334, 41342, 41348, 41349, 42038, 42050, 42221, 42926, 44067, 44149, 44153, 44168, 57452, 57561, 57562, 57630, 57646, 58031, 58111, 58152, 58173, 58176, 58186, 58187, 58191, 60446, 63332, 63437, 66446, 67361, 67495, 67535, 67755, 67773, 68204, 68231, 69118, 69128, 72744, 72910, 74975, 75069, 75072, 76784, 76804, 76820, 76822, 76823, 76824, 76831, 77155]
list_of_unique_sets = get_target_set_ids()
#
print(len(list_of_card_ids_no_pop))
# for card_id in list_of_favorite_card_ids:
    # get_volume_of_transactions(card_id, delete_cache=True)

# for set_id in find_stale_cache_files():
#     get_card_prices(set_id, delete_cache=True)

def update_psa_pops(card_ids = None):
    if card_ids == None:
        print("USING DB TO SEE WHICH ARE MISSING")
        card_ids = candidates_dao_instance.get_card_id_list_of_profitable_cards_without_gem_rate(min_value_increase=50, min_psa10_price=80)
        print(card_ids)
        print(len(card_ids))

    for card_id in card_ids:
        print(card_id)
        data = get_card_id_psa_pop(card_id, delete_cache=True)
        if data and isinstance(data, dict) and len(data) > 2:
            try:
                psa_dao_instance.add_psa_population_from_json(card_id, data)
            except Exception as e:
                print(e)

def update_sales_price_data(set_ids = None):
    if set_ids == None:
        return
    for set_id in set_ids:
        data = get_card_prices(set_id, delete_cache=True)
        set_dao_instance.add_set_from_json(data)

def update_missing_sales_volume_cards(card_ids):
    for card_id in card_ids:
        print(f"Trying to update {card_id}")
        data = get_volume_of_transactions(card_id, delete_cache=True)
        sales_dao_instance.add_sales_from_json(data)

        # After processing all cards, log the refresh attempt for the entire batch
    if card_ids:
        refresh_log_dao_instance.log_batch_refresh_attempt(card_ids)


def run_update_cycle():
    """
    This function can be called by an endpoint to run the full update cycle
    for missing data, respecting refresh intervals.
    """

    print("--- Starting update cycle ---")
    update_psa_pops(list_of_card_ids_no_pop)

    """Only run this if you want to update the sales data """
    stale_sets_from_db = set_dao_instance.get_stale_outdated_sets_list(1)
    print("stale_sets ", stale_sets_from_db)
    update_sales_price_data(stale_sets_from_db)

    """ Run this if we are missing sales volume data"""
    print("\nFinding profitable candidates without recent sales volume...")
    list_of_volume_data_cards = candidates_dao_instance.find_profitable_candidates_without_sales_volume(20, 70, days_since_last_attempt=7)
    card_ids_without_volume = [candidate['card_id'] for candidate in list_of_volume_data_cards]

    if card_ids_without_volume:
        print(f"Found {len(card_ids_without_volume)} cards to update sales volume for: {card_ids_without_volume}")
        update_missing_sales_volume_cards(card_ids_without_volume, sales_dao_instance, refresh_log_dao_instance)
    else:
        print("No cards need sales volume updates at this time.")

    print("\nPopulating card analytics for all cards...")
    populate_card_analytics_from_db(psa_dao_instance)

    print("\nPopulating grading financials for all cards...")
    populate_grading_financials_from_db(candidates_dao_instance)

    print("\n--- Update cycle finished ---")




if __name__ == '__main__':
    # Setup DI container
    container = AppContainer()
    container.wire(modules=[__name__])

    candidates_dao_instance: CandidatesDAO = container.candidates_dao()
    psa_dao_instance: PsaDAO = container.psa_dao()
    set_dao_instance: SetDAO = container.set_dao()
    sales_dao_instance: SalesDAO = container.sales_dao()
    refresh_log_dao_instance: SalesVolumeRefreshLogDAO = container.sales_volume_refresh_log_dao()
    run_update_cycle()

